---
title: "Capstone Group 2"
author: ""
date: "6/17/2022"
output: 
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center")

library(tidyverse)
library(survival)
library(survminer)
library(Hmisc)
library(gtsummary)
```

# Load data

```{r}
w1 <- read.csv("wave1.csv")
w2 <- read.csv("wave2.csv")
w1$wave <- "wave1"
w2$wave <- "wave2"
wave <- rbind(w1, w2)
```

# Data cleaning

```{r}
# chronic liver disease or gastrointestinal conditions
# - cirrhosis
# - hepatitis
# - ibd(inflammatory bowel disease)

wave_clean <- wave %>%
  # cirrhosis
  mutate(cirrhosis_factor = ifelse(cirrhosis %in% 'Yes', 
                                   1, 
                                   ifelse(cirrhosis == '', NA, 0))) %>%
  # inflammatory bowel disease
  mutate(ibd_factor = ifelse(ibd %in% 'Yes', 
                             1, 
                             ifelse(ibd == '', NA, 0))) %>%
  # hepatitis
  mutate(hep_factor = ifelse(apply(sapply(c('Hepatitis C', 'Hepatitis B'), 
                                          grepl, 
                                          hepatitis), 
                                   MARGIN =  1, 
                                   FUN = any), 
                             1, 
                             ifelse(hepatitis == '', NA, 0))) %>%
  mutate(gi_condition = ifelse(cirrhosis_factor == 1 | 
                               ibd_factor == 1 | 
                               hep_factor == 1, 1, 0))

# relevel & label
wave_clean$cirrhosis_factor <- factor(wave_clean$cirrhosis_factor, levels=c(0, 1), labels=c("No", "Yes"))
wave_clean$ibd_factor <- factor(wave_clean$ibd_factor, levels=c(0, 1), labels=c("No", "Yes"))
wave_clean$hep_factor <- factor(wave_clean$hep_factor, levels=c(0, 1), labels=c("No", "Yes"))
wave_clean$gi_condition <- factor(wave_clean$gi_condition, levels=c(0, 1), labels=c("No", "Yes"))
label(wave_clean$cirrhosis_factor) <- "Cirrhosis"
label(wave_clean$ibd_factor) <- "Inflammatory Bowel Disease"
label(wave_clean$hep_factor) <- "Hepatitis"
label(wave_clean$gi_condition) <- "Chronic GI Condition"
```

```{r}
# COVID GI Symptoms and In-hospital life threatening complications
# - symptoms
# - complications

wave_clean <- wave_clean %>%
         # GI symptoms
  mutate(gi_symptoms = ifelse(grepl("Abdominal Pain|Nausea|Diarrhea", 
                                    symptoms), 
                              1, 
                              ifelse(symptoms == "", NA, 0)),
         # In-hospital life threatening complications
         life_threat_comp = ifelse(complications != "None" & 
                                   complications != "",
                                   1, 
                                   ifelse(complications == "", NA, 0))) %>%
  mutate(comp_factor = ifelse(life_threat_comp == 1 | 
                              !(vte %in% c("No", "No | No", "")) | 
                              renal_replacement == "Yes", 1, 0))

wave_clean$gi_symptoms <- factor(wave_clean$gi_symptoms, levels=c(0, 1), labels=c("No", "Yes"))
wave_clean$comp_factor <- factor(wave_clean$comp_factor, levels=c(0, 1), labels=c("No", "Yes"))
label(wave_clean$gi_symptoms) <- "Covid GI symptoms"
label(wave_clean$comp_factor) <- "Life Threatening Complications"
```

```{r}
# Covariates
# - Comorbidities:
#   - htn
#   - cad
#   - hf
#   - cva
#   - dm
# - active_cancer
# - BMI (obesity)
# - sex
# - race_eth
# - age

wave_clean <- wave_clean %>%
  # cancer
  mutate(cancer_factor = ifelse(apply(sapply(c('Liquid', 'Solid'), 
                                             grepl, 
                                             active_cancer), 
                                      MARGIN =  1, 
                                      FUN = any), 
                                1, 
                                ifelse(active_cancer == '', NA, 0))) %>%
  # obesity: BMI >= 30
  mutate(bmi = ifelse(bmi == '33.8 | 33.8', 33.8, bmi), 
         bmi = ifelse(bmi == '24.4 | 24.4', 24.4, bmi)) %>%
  mutate(obesity = ifelse(bmi >= 30, 1, ifelse(bmi == '', NA, 0))) %>%
  # comorbidities
  mutate(dm_factor = ifelse(grepl("Yes", dm), 
                            1, 
                            ifelse(dm == '', NA, 0))) %>%
  mutate(htn_factor = ifelse(grepl("Yes", htn),
                             1,
                             ifelse(htn == "", NA, 0))) %>%
  mutate(cad_factor = ifelse(grepl("Yes", cad),
                             1,
                             ifelse(cad == "", NA, 0))) %>%
  mutate(hf_factor = ifelse(grepl("No", hf),
                            0,
                            ifelse(hf == "", NA, 1))) %>%
  mutate(cva_factor = ifelse(cva %in% "Yes",
                             1,
                             ifelse(cva == "", NA, 0))) %>%
  mutate(cva_comorbidity = ifelse(dm_factor == 1 | 
                                  htn_factor == 1 | 
                                  cad_factor == 1 | 
                                  hf_factor == 1 | 
                                  cva_factor == 1,
                                  1, 0)) %>%
  # sex
  mutate(sex = ifelse(sex == 'Female | Female', 
                      'Female',
                      ifelse(sex == '', NA, sex)))

# relevel & label

wave_clean$sex <- factor(wave_clean$sex, levels=c("Male","Female"))
label(wave_clean$sex) <- "Sex"

wave_clean$race_eth <- factor(wave_clean$race_eth, levels=c("4", "2", "3", "1", "5"))
levels(wave_clean$race_eth) <- c("White", "Black", "Asian", "Hispanic", "Other")
label(wave_clean$race_eth) <- "Race"

wave_clean$age_cat <- factor(wave_clean$age_cat, levels=c("1", "2", "3", "4", "5", "6"))
levels(wave_clean$age_cat) <- c("18 - 25", "26 - 40", "41 - 55", "56 - 70", "71 - 85", "86+")
label(wave_clean$age_cat) <- "Age"

wave_clean$cancer_factor <- factor(wave_clean$cancer_factor, levels=c(0, 1), labels=c("No", "Yes"))
label(wave_clean$cancer_factor) <- "Active Cancer"

wave_clean$cva_comorbidity <- factor(wave_clean$cva_comorbidity, levels=c(0, 1), labels=c("No", "Yes"))
label(wave_clean$cva_comorbidity) <- "Cardio Comorbidity"

wave_clean$obesity <- factor(wave_clean$obesity, levels=c(0, 1), labels=c("No", "Yes"))
label(wave_clean$obesity) <- "Obesity"
```

```{r}
# survival
wave_clean <- wave_clean %>% 
  mutate(ed_dt = as.Date(ed_dt, format = '%m/%d/%Y'),
         intubation1_dt = as.Date(intubation1_dt, format = '%m/%d/%Y'),
         death_dt = as.Date(death_dt, format = '%m/%d/%Y'),
         discharge_dt = as.Date(discharge_dt, format = '%m/%d/%Y'),
         transfer_out_dt = as.Date(transfer_out_dt, format = '%m/%d/%Y'),
         discharge_transfer_dt = if_else(is.na(discharge_dt), 
                                         transfer_out_dt, 
                                         discharge_dt),
         censor_death_dt = if_else(grepl("Yes", death), 
                                   death_dt, 
                                   discharge_transfer_dt),
         ## time to death 
         censer_death = as.numeric(difftime(censor_death_dt, ed_dt, 
                                            unit = 'days')),
         censor_intuba_dt = if_else(grepl("Yes", intubation1),
                                    intubation1_dt, 
                                    discharge_transfer_dt),
         ## time to intubation 
         censer_intuba = as.numeric(difftime(censor_intuba_dt, ed_dt, 
                                             unit = 'days'))) %>% 
  mutate(intubation1 = ifelse(grepl("Yes", intubation1),
                              1,
                              ifelse(intubation1 == "", NA, 0)),
         death = ifelse(grepl("Yes", death),
                        1,
                        ifelse(death == "", NA, 0)))

wave_clean$death <- factor(wave_clean$death, levels=c(0, 1), labels=c("No", "Yes"))
label(wave_clean$death) <- "Death"
label(wave_clean$censer_death) <- "Time to Death"
wave_clean$intubation1 <- factor(wave_clean$intubation1, levels=c(0, 1), labels=c("No", "Yes"))
label(wave_clean$intubation1) <- "Intubation"
label(wave_clean$censer_intuba) <- "Time to intubation"
```

# Table 1

```{r}
# descriptive stats by gi_condition
obj1_tb1 <- wave_clean %>%
  select(sex, race_eth, age_cat, obesity, cancer_factor, cva_comorbidity, gi_condition, gi_symptoms, wave) %>%
  tbl_summary(by = gi_condition,  missing = 'ifany',
              label = list(age_cat ~ "Age",
                           race_eth ~ "Race")) %>%
  add_p(all_categorical() ~ "chisq.test") %>%
  add_overall() %>%
  modify_caption("**Table 1. By GI Condition**") %>%
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Chronic GI conditions**")
obj1_tb1
```

```{r}
# descriptive stats by gi_symptoms
obj2_tb1 <- wave_clean %>%
  select(sex, race_eth, age_cat, obesity, cancer_factor, cva_comorbidity, gi_symptoms, comp_factor, intubation1, death, wave) %>%
  tbl_summary(by = gi_symptoms, missing = 'ifany',
              label = list(age_cat ~ "Age",
                           race_eth ~ "Race",
                           intubation1 ~ "Intubation")) %>%
  add_p() %>%
  add_overall() %>%
  modify_caption("**Table 2. By GI Symptoms**") %>%
  modify_spanning_header(c("stat_1", "stat_2") ~ "**GI symptoms**")
obj2_tb1
```

```{r}
# descriptive stats by wave
overall_tb1 <- wave_clean %>%
  select(sex, race_eth, age_cat, obesity, cancer_factor, cva_comorbidity, gi_condition, gi_symptoms, comp_factor, intubation1, death, wave) %>%
  tbl_summary(by = wave,  missing = 'ifany',
              label = list(age_cat ~ "Age",
                           race_eth ~ "Race")) %>%
  add_p() %>%
  add_overall() %>%
  modify_caption("**Table 1. Overall**") 
overall_tb1
```

# Objective 1

**Determine if patients who were hospitalized with GI/Hepatic conditions during the first two waves of COVID 19 were more likely to report having GI symptoms.**

Primary exposure: Presence of chronic liver disease or chronic gastrointestinal conditions, including hepatitis B, hepatitis C, cirrhosis, liver transplants, or inflammatory bowel disease. 

Primary outcome: COVID Symptoms, including abdominal pain, nausea or diarrhea.

## Logistic model
```{r}
fit_obj1 <- glm(gi_symptoms ~ gi_condition + sex + race_eth + age_cat + obesity + cancer_factor + cva_comorbidity + sex*gi_condition + wave, data = wave_clean, family = "binomial")
summary(fit_obj1)
```

```{r}
# Odds Ratio
round(exp(cbind(OR = coef(fit_obj1), confint(fit_obj1))), 3)
```

# Objective 2

**Determine if patients hospitalized with GI symptoms during the first two waves of COVID 19 had similar in-hospital outcomes to those who did not report such symptoms.**

Primary exposure: COVID Symptoms, including abdominal pain, nausea or diarrhea.

Primary outcome: in-hospital life threatening complications (Septic shock, positive blood culture, renal replacement therapy, arrhythmias, myocardial infarction, heart failure, venous thrombus embolism, coagulation), intubation, or death. 

## Logistic model
```{r}
wave_clean <- wave_clean %>%
  mutate(outcome = ifelse(comp_factor == "Yes" | death == "Yes" | intubation1 == "Yes", 1, 0))

fit_obj2 <- glm(outcome ~ gi_symptoms + sex + race_eth + age_cat + obesity + cancer_factor + cva_comorbidity + wave, data = wave_clean, family = "binomial")
summary(fit_obj2)
```

```{r}
# Odds Ratio
round(exp(cbind(OR = coef(fit_obj2), confint(fit_obj2))), 3)
```

## Death Survival
```{r}
survdiff(Surv(censer_death, as.numeric(death)) ~ gi_symptoms, data = wave_clean)

ggsurvplot(
  fit = survfit(Surv(censer_death, as.numeric(death)) ~ gi_symptoms, data = wave_clean),
  xlab = "Days",
  ylab = "Survival probability",
  pval = TRUE,
  surv.median.line = "hv",
  risk.table = TRUE
)

survfit(Surv(censer_death, as.numeric(death)) ~ gi_symptoms, data = wave_clean)
```

# Objective 3

**Determine in-hospital complications, including mortality among those with GI/Hepatic comorbidities of Covid 19 hospitalizations in a large hospital in NYC **

Primary exposure: Presence of chronic liver disease or chronic gastrointestinal conditions, including hepatitis B, hepatitis C, cirrhosis, liver transplants, or inflammatory bowel disease

Primary outcome: in-hospital life threatening complications (Septic shock, positive blood culture, renal replacement therapy, arrhythmias, myocardial infarction, heart failure, venous thrombus embolism, coagulation), intubation, or death. 

```{r}
# descriptive stats
# obj3_tb1 <- wave_clean %>%
#   select(sex, race_eth, age_cat, obesity, cancer_factor, cva_comorbidity, gi_condition, comp_factor, intubation1, death) %>%
#   tbl_summary(by = gi_condition, missing = 'no',
#               label = list(age_cat ~ "Age",
#                            race_eth ~ "Race",
#                            intubation1 ~ "Intubation")) %>%
#   add_p() %>%
#   add_overall() %>%
#   modify_caption("**Table 3. Objective 3**") %>%
#   modify_spanning_header(c("stat_1", "stat_2") ~ "**GI condition**")
# obj3_tb1
```

## Logistic model
```{r}
## outcome
fit_obj3_outcome <- glm(outcome ~ gi_condition + sex + race_eth + age_cat + obesity + cancer_factor + cva_comorbidity + sex*gi_condition + wave, wave_clean, family = binomial)
summary(fit_obj3_outcome)

## death
fit_obj3_death <- glm(death ~ gi_condition + sex + race_eth + age_cat + obesity + cancer_factor + cva_comorbidity + wave, wave_clean, family = binomial)
summary(fit_obj3_death)

## intubation
fit_obj3_intuba <- glm(intubation1 ~ gi_condition + sex + race_eth + age_cat + obesity + cancer_factor + cva_comorbidity + wave, wave_clean, family = binomial)
summary(fit_obj3_intuba)

## complication
fit_obj3_comp <- glm(comp_factor ~ gi_condition + sex + race_eth + age_cat + obesity + cancer_factor + cva_comorbidity + wave, wave_clean, family = binomial)
summary(fit_obj3_comp)
```

```{r}
# Odds Ratio
round(exp(cbind(OR = coef(fit_obj3_outcome), confint(fit_obj3_outcome))), 3)
```

## Death Survival
```{r}
## death-survial
wave_clean$death_code = as.numeric(wave_clean$death)
ggsurvplot( 
  fit = survfit(Surv(censer_death,death_code) ~ gi_condition, data = wave_clean),
  xlab = "Days", 
  ylab = "Survival probability",
  pval = TRUE,
  surv.median.line = "hv",
  risk.table = TRUE)

survfit(Surv(censer_death, death_code) ~ gi_condition, data = wave_clean)
```


# Objective 4

**Describe patient-reported outcomes (PROs) and clinical outcomes among patients with a subset of patients with GI/Hepatic conditions approximately one year after COVID admission (details are in the original proposal). **

Objective 4: Original proposal.

Primary exposure: Presence of chronic liver disease or chronic gastrointestinal conditions, including hepatitis B, hepatitis C, cirrhosis, liver transplants, or inflammatory bowel disease

Primary outcome: Patient Reported Outcomes (PROs): Post Acute Covid Sequalae such as brain fog, cough, shortness of breath, neuropathy, headache, muscle aches, diarrhea, chest pain, abdominal pain, loss of smell taste, fatigue or other.
Clinical outcomes: post hospitalization readmission or death.
